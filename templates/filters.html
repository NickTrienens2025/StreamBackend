{% extends "base.html" %}

{% block title %}Filter Goals - NHL Goals Feed{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/getstream/dist/js_min/getstream.js"></script>
<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #f8f9fa;
        margin: 0;
        padding: 0;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 30px 20px;
    }

    .page-header {
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .page-header h1 {
        font-size: 1.8em;
        margin: 0;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .page-header p {
        margin: 5px 0 0 0;
        color: #7f8c8d;
    }

    .filter-panel {
        background: white;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }

    .section-title {
        font-size: 0.85em;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #95a5a6;
        font-weight: 700;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* Chip Styles */
    .filter-group {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 24px;
    }

    .filter-chip {
        position: relative;
    }

    .filter-chip input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
    }

    .filter-chip label {
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        background-color: #f1f3f5;
        border: 1px solid transparent;
        border-radius: 50px;
        font-size: 0.9em;
        font-weight: 600;
        color: #495057;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        user-select: none;
    }

    .filter-chip label:hover {
        background-color: #e9ecef;
        transform: translateY(-1px);
    }

    .filter-chip input:checked+label {
        background-color: #e7f1ff;
        color: #0066cc;
        border-color: #b3d7ff;
        box-shadow: 0 2px 5px rgba(0, 102, 204, 0.15);
    }

    /* Team specific styles */
    .team-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 8px;
        max-height: 200px;
        overflow-y: auto;
        padding: 4px;
    }

    .team-chip input:checked+label {
        background-color: #0066cc;
        color: white;
        border-color: #0066cc;
    }

    .team-chip label {
        padding: 6px 10px;
        justify-content: center;
        font-size: 0.85em;
        width: 100%;
        box-sizing: border-box;
    }

    /* Search Input */
    .search-container {
        position: relative;
        margin-bottom: 12px;
    }

    .search-input {
        width: 100%;
        padding: 10px 10px 10px 36px;
        border: 1px solid #e1e4e8;
        border-radius: 8px;
        font-size: 0.9em;
        background-color: #f8f9fa;
        transition: all 0.2s;
        box-sizing: border-box;
    }

    .search-input:focus {
        outline: none;
        border-color: #0066cc;
        background-color: white;
        box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
    }

    .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #adb5bd;
    }

    /* Layout Sections */
    .filter-layout {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 30px;
    }

    @media (max-width: 900px) {
        .filter-layout {
            grid-template-columns: 1fr;
        }
    }

    /* Action Bar */
    .action-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 20px;
        border-top: 1px solid #eee;
        margin-top: 10px;
    }

    .btn {
        padding: 10px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
        color: white;
        box-shadow: 0 2px 6px rgba(0, 102, 204, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 102, 204, 0.4);
    }

    .btn-secondary {
        background: white;
        color: #6c757d;
        border: 1px solid #dee2e6;
    }

    .btn-secondary:hover {
        background: #f8f9fa;
        color: #495057;
        border-color: #adb5bd;
    }

    .results-count {
        font-weight: 600;
        color: #2c3e50;
    }

    /* Results Grid */
    #results-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
    }

    .activity-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
        transition: all 0.3s ease;
        border: 1px solid rgba(0, 0, 0, 0.03);
    }

    .activity-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
    }

    /* Reusing some improved styles from existing */
    .game-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: #fcfcfc;
        border-bottom: 1px solid #f0f0f0;
        font-size: 0.8em;
    }

    .game-status {
        color: #0066cc;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .activity-time {
        color: #999;
        font-weight: 500;
    }

    .card-content {
        padding: 16px;
    }

    .teams-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
    }

    .team {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 80px;
        transition: opacity 0.3s ease;
    }

    .team.opponent-team {
        opacity: 0.5;
        filter: grayscale(100%);
    }

    .team.scoring-team {
        opacity: 1;
        transform: scale(1.05);
    }

    .team-logo {
        width: 45px;
        height: 45px;
        object-fit: contain;
        margin-bottom: 4px;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }

    .team-code {
        font-weight: 700;
        font-size: 0.9em;
        color: #2c3e50;
    }

    .team-score {
        font-size: 1.6em;
        font-weight: 900;
        color: #2c3e50;
    }

    .vs-divider {
        color: #cbd5e0;
        font-weight: 600;
        font-size: 0.8em;
        margin-top: -20px;
    }

    .event-badge {
        display: inline-block;
        background: #ffebee;
        color: #c62828;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.75em;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 12px;
    }

    .scorer-info {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
    }

    .player-headshot {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .scorer-text {
        text-align: left;
    }

    .scorer-name {
        display: block;
        font-size: 1.1em;
        font-weight: 800;
        color: #2c3e50;
        line-height: 1.2;
    }

    .scorer-meta {
        font-size: 0.8em;
        color: #7f8c8d;
        font-weight: 500;
    }

    .tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #f5f5f5;
    }

    .tag {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 6px;
        font-size: 0.75em;
        font-weight: 600;
    }

    .tag.special {
        background: #fff8e1;
        color: #f57f17;
    }

    .tag.clutch {
        background: #fce4ec;
        color: #c2185b;
    }

    .sort-control select {
        padding: 8px 12px;
        border: 1px solid #e1e4e8;
        border-radius: 8px;
        font-size: 0.9em;
        cursor: pointer;
        background-color: white;
    }

    .no-results {
        text-align: center;
        padding: 60px;
        background: white;
        border-radius: 12px;
        color: #999;
        border: 2px dashed #eee;
    }

    .no-results h3 {
        font-size: 1.5em;
        margin: 0 0 10px 0;
        color: #7f8c8d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <div>
            <h1>üèí Filter Goals</h1>
            <p>Find specific goals by team, type, situation, and more</p>
        </div>
        <div class="sort-control">
            <select id="sort-select" onchange="applyFilters()">
                <option value="time">Latest First</option>
                <option value="score">Most Important</option>
            </select>
        </div>
    </div>

    <div class="filter-panel">
        <div class="filter-layout">
            <!-- Left Column: Teams -->
            <div class="filter-column">
                <div class="section-title">
                    <span>Teams</span>
                </div>

                <div class="search-container">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" id="team-search" placeholder="Search teams..."
                        oninput="filterTeams(this.value)">
                </div>

                <div id="team-filters" class="team-grid">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Right Column: Other Filters -->
            <div class="filter-column">
                <div class="section-title">üéØ Goal Types</div>
                <div class="filter-group">
                    <div class="filter-chip"><input type="checkbox" id="game-winner" value="game-winner"><label
                            for="game-winner">Game Winner</label></div>
                    <div class="filter-chip"><input type="checkbox" id="overtime" value="overtime"><label
                            for="overtime">Overtime</label></div>
                    <div class="filter-chip"><input type="checkbox" id="shootout" value="shootout"><label
                            for="shootout">Shootout</label></div>
                    <div class="filter-chip"><input type="checkbox" id="empty-net" value="empty-net"><label
                            for="empty-net">Empty Net</label></div>
                    <div class="filter-chip"><input type="checkbox" id="penalty-shot" value="penalty-shot"><label
                            for="penalty-shot">Penalty Shot</label></div>
                    <div class="filter-chip"><input type="checkbox" id="powerplay" value="powerplay"><label
                            for="powerplay">Power Play</label></div>
                    <div class="filter-chip"><input type="checkbox" id="shorthanded" value="shorthanded"><label
                            for="shorthanded">Short Handed</label></div>
                </div>

                <div class="section-title">‚ö° Clutch Situations</div>
                <div class="filter-group">
                    <div class="filter-chip"><input type="checkbox" id="tying-goal" value="tying-goal"><label
                            for="tying-goal">Tying Goal</label></div>
                    <div class="filter-chip"><input type="checkbox" id="go-ahead-goal" value="go-ahead-goal"><label
                            for="go-ahead-goal">Go-Ahead</label></div>
                    <div class="filter-chip"><input type="checkbox" id="comeback" value="comeback"><label
                            for="comeback">Comeback</label></div>
                    <div class="filter-chip"><input type="checkbox" id="late-period" value="late-period"><label
                            for="late-period">Late Period</label></div>
                    <div class="filter-chip"><input type="checkbox" id="buzzer-beater" value="buzzer-beater"><label
                            for="buzzer-beater">Buzzer Beater</label></div>
                    <div class="filter-chip"><input type="checkbox" id="close-game" value="close-game"><label
                            for="close-game">Close Game</label></div>
                    <div class="filter-chip"><input type="checkbox" id="first-goal" value="first-goal"><label
                            for="first-goal">First Goal</label></div>
                </div>

                <div class="section-title">ü•Ö Shot Types</div>
                <div class="filter-group">
                    <div class="filter-chip"><input type="checkbox" id="wrist" value="shot:wrist"><label
                            for="wrist">Wrist</label></div>
                    <div class="filter-chip"><input type="checkbox" id="snap" value="shot:snap"><label
                            for="snap">Snap</label></div>
                    <div class="filter-chip"><input type="checkbox" id="slap" value="shot:slap"><label
                            for="slap">Slap</label></div>
                    <div class="filter-chip"><input type="checkbox" id="backhand" value="shot:backhand"><label
                            for="backhand">Backhand</label></div>
                    <div class="filter-chip"><input type="checkbox" id="tip-in" value="shot:tip-in"><label
                            for="tip-in">Tip-In</label></div>
                    <div class="filter-chip"><input type="checkbox" id="wrap-around" value="shot:wrap-around"><label
                            for="wrap-around">Wrap-Around</label></div>
                    <div class="filter-chip"><input type="checkbox" id="deflected" value="shot:deflected"><label
                            for="deflected">Deflected</label></div>
                </div>
            </div>
        </div>

        <div class="action-bar">
            <span class="results-count" id="results-count">Loading goals...</span>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="clearFilters()">Clear</button>
                <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
            </div>
        </div>
    </div>

    <div id="results-container"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const API_PREFIX = '/api/v1';
    const NHL_TEAMS = [
        'ANA', 'BOS', 'BUF', 'CAR', 'CBJ', 'CGY', 'CHI', 'COL', 'DAL', 'DET',
        'EDM', 'FLA', 'LAK', 'MIN', 'MTL', 'NJD', 'NSH', 'NYI', 'NYR', 'OTT',
        'PHI', 'PIT', 'SEA', 'SJS', 'STL', 'TBL', 'TOR', 'VAN', 'VGK', 'WPG', 'WSH'
    ];

    let allActivities = [];

    function populateTeamFilters() {
        const container = document.getElementById('team-filters');
        container.innerHTML = ''; // Clear existing

        NHL_TEAMS.forEach(team => {
            const div = document.createElement('div');
            div.className = 'filter-chip team-chip';
            div.setAttribute('data-team', team);
            div.innerHTML = `
                <input type="checkbox" id="team-${team}" value="team:${team}">
                <label for="team-${team}">${team}</label>
            `;
            container.appendChild(div);
        });

        // Add event listeners to all checkboxes to auto-apply filters? 
        // Or keep "Apply" button as primary? Let's keep Apply button for performance with many DOM updates
        // But maybe add live update for small interactions if desired.
        // For now, manual apply.
    }

    function filterTeams(query) {
        const q = query.toUpperCase();
        const chips = document.querySelectorAll('.team-chip');
        chips.forEach(chip => {
            const team = chip.getAttribute('data-team');
            if (team.includes(q)) {
                chip.style.display = 'block';
            } else {
                chip.style.display = 'none';
            }
        });
    }

    async function loadActivities() {
        try {
            const sortBy = document.getElementById('sort-select').value;
            const params = new URLSearchParams({
                limit: 1000,
                enrich: true
            });

            if (sortBy === 'score') {
                params.append('ranking', 'score');
            }

            const response = await fetch(`${API_PREFIX}/feeds/nhl/activities?${params}`);
            const data = await response.json();

            if (data.success) {
                allActivities = data.data;
                applyFilters();
            }
        } catch (error) {
            console.error('Error loading activities:', error);
            document.getElementById('results-container').innerHTML = `
                <div class="no-results">
                    <h3>Error loading goals</h3>
                    <p>${error.message}</p>
                </div>
            `;
        }
    }

    function getSelectedFilters() {
        const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
        return Array.from(checkboxes).map(cb => cb.value);
    }

    function applyFilters() {
        const selectedValues = getSelectedFilters();

        // 1. Split into Teams and Other filters
        const teamFilters = selectedValues.filter(val => val.startsWith('team:'));
        const otherFilters = selectedValues.filter(val => !val.startsWith('team:'));

        // Extract just the team abbreviations (e.g., "team:DET" -> "DET")
        const teamCodes = teamFilters.map(val => val.split(':')[1]);

        let filtered = allActivities;

        if (selectedValues.length > 0) {
            filtered = allActivities.filter(activity => {
                const activityTags = activity.interest_tags || [];

                // 2. Team Match Logic (OR)
                let teamMatch = true;
                if (teamCodes.length > 0) {
                    // Check if activity matches ANY selected team
                    teamMatch = teamCodes.some(code => {
                        // Check direct fields
                        if (activity.home_team === code) return true;
                        if (activity.away_team === code) return true;
                        if (activity.scoring_team === code) return true;

                        // Check interest tags (e.g. "team:DET")
                        if (activityTags.includes(`team:${code}`)) return true;

                        return false;
                    });
                }

                // 3. Other Filter Match Logic (OR)
                let otherMatch = true;
                if (otherFilters.length > 0) {
                    // Check if activity matches ANY selected other filter
                    otherMatch = otherFilters.some(filter => {
                        // All current other filters are tag-based
                        return activityTags.includes(filter);
                    });
                }

                // Combine with AND
                // (Must match simple team criteria IF teams selected) AND (Must match other criteria IF others selected)
                return teamMatch && otherMatch;
            });
        }

        document.getElementById('results-count').textContent =
            `${filtered.length} goal${filtered.length !== 1 ? 's' : ''} found`;

        renderResults(filtered);
    }

    function clearFilters() {
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        // Also clear search
        document.getElementById('team-search').value = '';
        filterTeams('');
        applyFilters();
    }

    function renderResults(activities) {
        const container = document.getElementById('results-container');

        if (activities.length === 0) {
            container.innerHTML = `
                <div class="no-results" style="grid-column: 1 / -1;">
                    <h3>No goals found</h3>
                    <p>Try adjusting your filters</p>
                </div>
            `;
            return;
        }

        container.innerHTML = activities.map(activity => {
            const homeTeam = activity.home_team || 'NHL';
            const awayTeam = activity.away_team || 'NHL';
            const homeScore = activity.home_score || 0;
            const awayScore = activity.away_score || 0;
            const period = activity.period || '';
            const timeRemaining = activity.time_remaining || '';
            const scoringTeam = activity.scoring_team || '';
            const scorerName = activity.scoring_player_name || 'Unknown';
            const scorerHeadshot = activity.scoring_player_headshot;
            const scorerPosition = activity.scoring_player_position;
            const scorerSweater = activity.scoring_player_sweater;
            const shotType = activity.shot_type || '';
            const goalType = activity.goal_type || '';
            const gameDate = activity.time ? new Date(activity.time).toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' }) : '';

            const isHomeScoring = scoringTeam === homeTeam;
            const isAwayScoring = scoringTeam === awayTeam;

            const homeLogo = `https://assets.nhle.com/logos/nhl/svg/${homeTeam}_light.svg`;
            const awayLogo = `https://assets.nhle.com/logos/nhl/svg/${awayTeam}_light.svg`;
            const scoringTeamLogo = scoringTeam ? `https://assets.nhle.com/logos/nhl/svg/${scoringTeam}_light.svg` : null;

            const tags = activity.interest_tags || [];
            const specialTags = tags.filter(tag =>
                ['game-winner', 'overtime', 'shootout', 'empty-net', 'penalty-shot'].includes(tag)
            );
            const clutchTags = tags.filter(tag =>
                ['tying-goal', 'go-ahead-goal', 'comeback', 'late-period', 'buzzer-beater', 'close-game'].includes(tag)
            );

            return `
                <div class="activity-card">
                    <div class="game-header">
                        <span class="game-status">P${period} ‚Ä¢ ${timeRemaining}</span>
                        <span class="activity-time">${gameDate}</span>
                    </div>

                    <div class="card-content">
                        <div class="teams-container">
                            <div class="team ${isAwayScoring ? 'scoring-team' : 'opponent-team'}">
                                <img src="${awayLogo}" alt="${awayTeam}" class="team-logo" onerror="this.src='https://assets.nhle.com/logos/nhl/svg/NHL_light.svg'">
                                <div class="team-code">${awayTeam}</div>
                                <div class="team-score">${awayScore}</div>
                            </div>

                            <div class="vs-divider">VS</div>

                            <div class="team ${isHomeScoring ? 'scoring-team' : 'opponent-team'}">
                                <img src="${homeLogo}" alt="${homeTeam}" class="team-logo" onerror="this.src='https://assets.nhle.com/logos/nhl/svg/NHL_light.svg'">
                                <div class="team-code">${homeTeam}</div>
                                <div class="team-score">${homeScore}</div>
                            </div>
                        </div>

                        <div class="event-badge">GOAL</div>

                        <div class="scorer-info">
                            ${scorerHeadshot ? `<img src="${scorerHeadshot}" class="player-headshot" alt="${scorerName}" onerror="this.src='${scoringTeamLogo}'">` : `<img src="${scoringTeamLogo}" class="player-headshot" alt="${scoringTeam}">`}
                            <div class="scorer-text">
                                <span class="scorer-name">${scorerName}</span>
                                <div class="scorer-meta">
                                    ${scorerPosition ? `${scorerPosition} ‚Ä¢ ` : ''}
                                    ${scorerSweater ? `#${scorerSweater} ‚Ä¢ ` : ''}
                                    ${shotType}
                                </div>
                            </div>
                        </div>

                        <div class="tags-container">
                            ${specialTags.map(tag => `<span class="tag special">${tag}</span>`).join('')}
                            ${clutchTags.map(tag => `<span class="tag clutch">${tag}</span>`).join('')}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    populateTeamFilters();
    loadActivities();
</script>
{% endblock %}